{% extends "layout.html" %}

{% block content %}
<style>/* From Uiverse.io by vinodjangid07 */ 
    .visa-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      width: 300px;
      height: 180px;
      background-image: radial-gradient(
        circle 897px at 9% 80.3%,
        rgba(55, 60, 245, 1) 0%,
        rgba(234, 161, 15, 0.9) 100.2%
      );
      border-radius: 10px;
      padding: 20px;
      font-family: Arial, Helvetica, sans-serif;
      position: relative;
      gap: 15px;
    }
    .logoContainer {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      height: fit-content;
      position: absolute;
      top: 0;
      left: 0;
      padding: 18px;
    }
    .svgLogo {
      height: 40px;
      width: auto;
    }
    .inputstyle::placeholder {
      color: #ffffff;
    }
    .inputstyle {
      background-color: transparent;
      border: none;
      outline: none;
      color: white;
      caret-color: red;
      font-size: 13px;
      height: 25px;
      letter-spacing: 1.5px;
    }
    .number-container {
      width: 100%;
      height: fit-content;
      display: flex;
      flex-direction: column;
    }
    #cardNumber {
      width: 100%;
      height: 25px;
    }
    .name-date-cvv-container {
      width: 100%;
      height: 25px;
      display: flex;
      gap: 10px;
    }
    .name-wrapper {
      width: 60%;
      height: fit-content;
      display: flex;
      flex-direction: column;
    }
    .expiry-wrapper,
    .cvv-wrapper {
      width: 30%;
      height: fit-content;
      display: flex;
      flex-direction: column;
    }
    .cvv-wrapper {
      width: 10%;
    }
    #expiry,
    #cvv {
      width: 100%;
    }
    .input-label {
      font-size: 8px;
      letter-spacing: 1.5px;
      color: #e2e2e2;
      width: 100%;
    }
    </style>
<div class="container">
    <h1>Recarga de Saldo</h1>
    
    <!-- Sección de Saldo Actual dentro de un círculo azul -->
    <div class="saldo-actual" style="text-align: center; margin-bottom: 20px;">
        <div style="background-color: #007bff; color: white; width: 150px; height: 150px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
            <h3 id="saldo">MXN 100.00</h3>
        </div>
    </div>

    <!-- Sección de Recarga -->
    <div class="recarga">
        <h3>Recargar con Tarjeta de Crédito o Débito</h3>
        
       <!-- From Uiverse.io by vinodjangid07 --> 
<div class="visa-card">
    <div class="logoContainer">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        x="0px"
        y="0px"
        width="23"
        height="23"
        viewBox="0 0 48 48"
        class="svgLogo"
      >
        <path
          fill="#ff9800"
          d="M32 10A14 14 0 1 0 32 38A14 14 0 1 0 32 10Z"
        ></path>
        <path
          fill="#d50000"
          d="M16 10A14 14 0 1 0 16 38A14 14 0 1 0 16 10Z"
        ></path>
        <path
          fill="#ff3d00"
          d="M18,24c0,4.755,2.376,8.95,6,11.48c3.624-2.53,6-6.725,6-11.48s-2.376-8.95-6-11.48 C20.376,15.05,18,19.245,18,24z"
        ></path>
      </svg>
    </div>
    <div class="number-container">
      <label class="input-label" for="cardNumber">CARD NUMBER</label>
      <input
        class="inputstyle"
        id="cardNumber"
        placeholder="XXXX XXXX XXXX XXXX"
        name="cardNumber"
        type="text"
      />
    </div>
  
    <div class="name-date-cvv-container">
      <div class="name-wrapper">
        <label class="input-label" for="holderName">CARD HOLDER</label>
        <input
          class="inputstyle"
          id="holderName"
          placeholder="NAME"
          type="text"
        />
      </div>
  
      <div class="expiry-wrapper">
        <label class="input-label" for="expiry">VALID THRU</label>
        <input class="inputstyle" id="expiry" placeholder="MM/YY" type="text" />
      </div>
      <div class="cvv-wrapper">
        <label class="input-label" for="cvv">CVV</label>
        <input
          class="inputstyle"
          placeholder="***"
          maxlength="3"
          id="cvv"
          type="password"
        />
      </div>
    </div>
  </div>
  
    </div>

    <!-- Mapa de puntos de recarga con Leaflet -->
    <div class="mapa-recarga" style="margin-top: 30px;">
        <h3>Puntos de Recarga Cercanos</h3>
        <div id="map" style="height: 400px;"></div>
    </div>
</div>

<!-- Carga de Leaflet CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let puntosRecarga = []; // Inicializar variable

  // Cargar los puntos desde el backend de Flask
  fetch('/api/puntos_recarga')
      .then(response => response.json())
      .then(data => {
          puntosRecarga = data; // Guardar los puntos de recarga en la variable
          console.log("Puntos de recarga cargados:", puntosRecarga);
          obtenerUbicacionYMostrarPuntos(); // Llamar función para obtener ubicación y mostrar puntos
      })
      .catch(error => console.error('Error al cargar los puntos:', error));

  // Función para calcular la distancia entre dos puntos usando la fórmula de Haversine (opcional si lo necesitas)
  function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la Tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distancia en km
  }

  // Función para obtener la ubicación actual del usuario y mostrar todos los puntos en el mapa
  function obtenerUbicacionYMostrarPuntos() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              const latitudUsuario = position.coords.latitude;
              const longitudUsuario = position.coords.longitude;
              
              // Crear mapa centrado en la ubicación del usuario
              const map = L.map('map').setView([latitudUsuario, longitudUsuario], 13);

              // Agregar el mapa base de OpenStreetMap
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              // Añadir un marcador para la ubicación del usuario
              L.marker([latitudUsuario, longitudUsuario]).addTo(map)
                  .bindPopup("<b>Tu ubicación actual</b>")
                  .openPopup();

              // Mostrar todos los puntos de recarga en el mapa
              puntosRecarga.forEach(punto => {
                  // Usamos un marcador con color personalizado (por ejemplo, rojo)
                  L.marker([punto.latitud, punto.longitud], {
                      icon: L.icon({
                          iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png', // Icono por defecto
                          iconSize: [25, 41],
                          iconAnchor: [12, 41],
                          popupAnchor: [1, -34],
                          shadowSize: [41, 41]
                      })
                  }).addTo(map)
                  .bindPopup(`<b>Punto de Recarga</b><br>${punto.direccion}`);
              });

          }, function() {
              alert("No se pudo obtener la ubicación.");
          });
      } else {
          alert("La geolocalización no está soportada por este navegador.");
      }
  }
</script>


{% endblock %}
