{% extends "layout.html" %}

{% block content %}
<style>/* From Uiverse.io by vinodjangid07 */ 
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif
}

.container {
    margin: 30px auto;
}

.container .card {
    width: 100%;
    box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    background: #fff;
    border-radius: 0px;
}





.btn.btn-primary {
    background-color: #ddd;
    color: black;
    box-shadow: none;
    border: none;
    font-size: 20px;
    width: 100%;
    height: 100%;
}

.btn.btn-primary:focus {
    box-shadow: none;
}

.container .card .img-box {
    width: 80px;
    height: 50px;
}

.container .card img {
    width: 100%;
    object-fit: fill;
}

.container .card .number {
    font-size: 24px;
}

.container .card-body .btn.btn-primary .fab.fa-cc-paypal {
    font-size: 32px;
    color: #3333f7;
}

.fab.fa-cc-amex {
    color: #1c6acf;
    font-size: 32px;
}

.fab.fa-cc-mastercard {
    font-size: 32px;
    color: red;
}

.fab.fa-cc-discover {
    font-size: 32px;
    color: orange;
}

.c-green {
    color: green;
}

.box {
    height: 40px;
    width: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ddd;
}

.btn.btn-primary.payment {
    background-color: #1c6acf;
    color: white;
    border-radius: 0px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 24px;
}


.form__div {
    height: 50px;
    position: relative;
    margin-bottom: 24px;
}

.form-control {
    width: 100%;
    height: 45px;
    font-size: 14px;
    border: 1px solid #DADCE0;
    border-radius: 0;
    outline: none;
    padding: 2px;
    background: none;
    z-index: 1;
    box-shadow: none;
}

.form__label {
    position: absolute;
    left: 16px;
    top: 10px;
    background-color: #fff;
    color: #80868B;
    font-size: 16px;
    transition: .3s;
    text-transform: uppercase;
}

.form-control:focus+.form__label {
    top: -8px;
    left: 12px;
    color: #1A73E8;
    font-size: 12px;
    font-weight: 500;
    z-index: 10;
}

.form-control:not(:placeholder-shown).form-control:not(:focus)+.form__label {
    top: -8px;
    left: 12px;
    font-size: 12px;
    font-weight: 500;
    z-index: 10;
}

.form-control:focus {
    border: 1.5px solid #1A73E8;
    box-shadow: none;
}

</style>
<head>    <script src="https://js.stripe.com/v3/"></script>
</head>
<div class="container">
    <h1>Recarga de Saldo</h1>
    
    <!-- Sección de Saldo Actual dentro de un círculo azul -->
    <div class="saldo-actual" style="text-align: center; margin-bottom: 20px;">
        <div style="background-color: #007bff; color: white; width: 250px; height: 250px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
            <h3 id="saldo">MXN 100.00 SALDO ACTUAL</h3>
        </div>
    </div>
<!-- Mapa de puntos de recarga con Leaflet -->
<div class="mapa-recarga" style="margin-top: 30px;">
  <h3>Puntos de Recarga Cercanos</h3>
  <div id="map" style="height: 400px;"></div>
</div>
    <!-- Sección de Recarga -->
    <div class="recarga">
      <h3>Recargar con Tarjeta de Crédito o Débito</h3>
      <div class="container">
          <div class="row">
              
              <div class="col-12 mt-4">
                  <div class="card p-3">
                      <p class="mb-0 fw-bold h4">Métodos de Pago</p>
                  </div>
              </div>
              <div class="col-12">
                  <div class="card p-3">
                      <div class="card-body border p-0">
                         
                          
                      </div>
                      <div class="card-body border p-0">
                          <p>
                              <a class="btn btn-primary p-2 w-100 h-100 d-flex align-items-center justify-content-between"
                                 data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="true"
                                 aria-controls="collapseExample">
                                  <span class="fw-bold">Tarjeta de Crédito</span>
                                  <span class="">
                                      <span class="fab fa-cc-amex"></span>
                                      <span class="fab fa-cc-mastercard"></span>
                                      <span class="fab fa-cc-discover"></span>
                                  </span>
                              </a>
                          </p>
                          <div class="collapse show p-3 pt-0" id="collapseExample">
                              <div class="row">
                                  <div class="col-lg-5 mb-lg-0 mb-3">
                                      <p class="h4 mb-0">Resumen</p>
                                      <p class="mb-0"><span class="fw-bold">Producto:</span><span class="c-green">: Nombre del producto</span></p>
                                      <p class="mb-0"><span class="fw-bold">Precio:</span><span class="c-green">:$452.90</span></p>
                                  </div>
                                  <div class="col-lg-7">
                                      <form action="" class="form">
                                          <div class="row">
                                              <div class="col-12">
                                                  <div class="form__div">
                                                      <input type="text" class="form-control" placeholder=" ">
                                                      <label for="" class="form__label">Número de tarjeta</label>
                                                  </div>
                                              </div>
  
                                              <div class="col-6">
                                                  <div class="form__div">
                                                      <input type="text" class="form-control" placeholder=" ">
                                                      <label for="" class="form__label">MM / aa</label>
                                                  </div>
                                              </div>
  
                                              <div class="col-6">
                                                  <div class="form__div">
                                                      <input type="password" class="form-control" placeholder=" ">
                                                      <label for="" class="form__label">Código CVV</label>
                                                  </div>
                                              </div>
                                              <div class="col-12">
                                                  <div class="form__div">
                                                      <input type="text" class="form-control" placeholder=" ">
                                                      <label for="" class="form__label">Nombre en la tarjeta</label>
                                                  </div>
                                              </div>
  
                                              <!-- Input para ingresar el monto -->
                                              <div class="col-12">
                                                  <div class="form__div">
                                                      <input type="number" class="form-control" placeholder=" " id="amount" required>
                                                      <label for="amount" class="form__label">Monto a pagar</label>
                                                  </div>
                                              </div>
                                              <div class="col-12">
                                                  <div class="btn btn-primary w-100">Enviar</div>
                                              </div>
                                          </div>
                                      </form>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="col-12">
                  <div class="btn btn-primary payment">
                      Realizar pago
                  </div>
              </div>
          </div>
      </div>
  </div>
  
<!-- Carga de Leaflet CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

  let puntosRecarga = []; // Inicializar variable

  // Cargar los puntos desde el backend de Flask
  fetch('/api/puntos_recarga')
      .then(response => response.json())
      .then(data => {
          puntosRecarga = data; // Guardar los puntos de recarga en la variable
          console.log("Puntos de recarga cargados:", puntosRecarga);
          obtenerUbicacionYMostrarPuntos(); // Llamar función para obtener ubicación y mostrar puntos
      })
      .catch(error => console.error('Error al cargar los puntos:', error));

  // Función para calcular la distancia entre dos puntos usando la fórmula de Haversine (opcional si lo necesitas)
  function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la Tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distancia en km
  }

   // Función para obtener la ubicación actual del usuario y mostrar los puntos alternadamente
   function obtenerUbicacionYMostrarPuntos() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              const latitudUsuario = position.coords.latitude;
              const longitudUsuario = position.coords.longitude;
              
              // Crear mapa centrado en la ubicación del usuario
              const map = L.map('map').setView([latitudUsuario, longitudUsuario], 13);

              // Agregar el mapa base de OpenStreetMap
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              // Añadir un marcador para la ubicación del usuario
              L.marker([latitudUsuario, longitudUsuario]).addTo(map)
                  .bindPopup("<b>Tu ubicación actual</b>")
                  .openPopup();

              // Mostrar solo los puntos alternados (uno sí, uno no)
              puntosRecarga.forEach((punto, index) => {
                  if (index % 2 === 0) {  // Solo muestra los puntos con índices pares
                      const customIcon = L.icon({
                          iconUrl: 'https://github.com/Yael200206/YOVOY/blob/main/app/static/soluciones.png?raw=true', // URL de tu imagen
                          iconSize: [32, 32], // Tamaño de la imagen
                          iconAnchor: [16, 32], // El punto de anclaje del icono
                          popupAnchor: [0, -32] // Donde se muestra el popup
                      });

                      // Crear un marcador con la imagen personalizada
                      L.marker([punto.latitud, punto.longitud], { icon: customIcon })
                          .addTo(map)
                          .bindPopup(`<b>Punto de Recarga</b><br>${punto.direccion}`);
                  }
              });

          }, function() {
              alert("No se pudo obtener la ubicación.");
          });
      } else {
          alert("La geolocalización no está soportada por este navegador.");
      }
  }
</script>

{% endblock %}
