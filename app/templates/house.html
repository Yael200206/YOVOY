    {% extends "layout.html" %}

    {% block content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Maps CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .hero {
            background: linear-gradient(rgba(66, 177, 237, 0.8), rgba(42, 45, 132, 0.8)), url('background.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 50px 20px;
            border-radius: 10px;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .fav-location {
            margin-top: 20px;
        }
        .fav-location .btn {
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            margin-right: 10px;
        }
        .fav-location .btn i {
            margin-right: 8px;
        }
        .fav-location .btn-home {
            background-color: #1E90FF;
            color: white;
        }
        .fav-location .btn-work {
            background-color: #4682B4;
            color: white;
        }
        .fav-location .btn-add {
            background-color: #5F9EA0;
            color: white;
        }
        .fav-location .btn:hover {
            opacity: 0.8;
        }
        .route-button {
            margin: 10px 0;
        }
        #searchResults {
            display: none;
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        #searchResults .list-group-item {
            cursor: pointer;
        }
    </style>

    <!-- Barra de búsqueda -->
    <section class="hero">
        <h1>¿A dónde quieres ir?</h1>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Escribe tu destino...">
            <button class="btn btn-primary" type="button" id="searchButton">Buscar</button>
        </div>
        <ul id="searchResults" class="list-group"></ul>  <!-- Lista de resultados -->
    </section>

    <!-- Lugares favoritos -->
    <section class="fav-location container">
        <h3>Lugares Favoritos</h3>
        <button class="btn btn-home" id="homeButton"><i class="bx bx-home"></i> Casa</button>
        <button class="btn btn-work" id="workButton"><i class="bx bx-briefcase"></i> Trabajo</button>
        <button class="btn btn-add" id="addLocationButton" data-bs-toggle="modal" data-bs-target="#addLocationModal"><i class="bx bx-plus-circle"></i> Guardar otro lugar</button>
    </section>
<BR>
    <!-- Mapa de ubicación -->
    <section>
        <div id="map" style="height: 400px;"></div>
    </section>

    <!-- Modal para agregar un lugar favorito -->
    <div class="modal fade" id="addLocationModal" tabindex="-1" aria-labelledby="addLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLocationModalLabel">Agregar lugar favorito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="newLocation">Nombre del lugar</label>
                    <input type="text" class="form-control" id="newLocation" placeholder="Ej. Parque, Restaurante">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveLocationButton">Guardar lugar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Google Maps JS -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCaTfrpS9pYoUrezV6CKF5QrPaxlJKhRQ&libraries=places&callback=initMap"></script>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let destinationInput = document.getElementById('searchInput');
        let searchResults = document.getElementById('searchResults');
        let placesService;

        function initMap() {
            // Inicia el mapa centrado en una ubicación predeterminada
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 21.8848, lng: -102.2933 } // Puedes establecer el centro que prefieras
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            geocoder = new google.maps.Geocoder();
            placesService = new google.maps.places.PlacesService(map);

            // Autocompletar para el input de destino
            new google.maps.places.Autocomplete(destinationInput);
        }

        function getCurrentLocation() {
    if (navigator.geolocation) {
        return new Promise((resolve, reject) => {
            // Solicitar la ubicación al usuario
            navigator.geolocation.getCurrentPosition(function(position) {
                resolve({
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                });
            }, function(error) {
                reject('Error al obtener la ubicación actual. Asegúrate de permitir la geolocalización.');
            });
        });
    } else {
        alert("Geolocalización no es compatible con este navegador.");
    }
}

        // Función para buscar lugares con Google Places API
        function searchLocations(query) {
            const request = {
                query: query,
                fields: ['name', 'geometry']
            };

            placesService.findPlaceFromQuery(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    showResults(results);
                } else {
                    console.error('Error al buscar lugares:', status);
                }
            });
        }

        // Función para mostrar los resultados de búsqueda en el listado
        function showResults(results) {
            searchResults.innerHTML = '';  // Limpiar resultados anteriores
            if (results.length > 0) {
                results.forEach(result => {
                    let listItem = document.createElement('li');
                    listItem.classList.add('list-group-item');
                    listItem.textContent = result.name;
                    listItem.addEventListener('click', function() {
                        destinationInput.value = result.name;
                        searchResults.style.display = 'none';
                    });
                    searchResults.appendChild(listItem);
                });
                searchResults.style.display = 'block';  // Mostrar la lista de resultados
            } else {
                searchResults.style.display = 'none';  // Ocultar la lista si no hay resultados
            }
        }

        function calculateRoute() {
    getCurrentLocation().then(origin => {
        let destination = destinationInput.value;

        if (!origin || !destination) {
            alert('Por favor, ingresa un destino.');
            return;
        }

        let request = {
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        };

        directionsService.route(request, function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(response);
            } else {
                console.error('Error al calcular la ruta:', status);
            }
        });
    }).catch(error => {
        alert('No se pudo obtener la ubicación actual: ' + error);
    });
}

        // Evento de búsqueda mientras se escribe en el input de destino
        destinationInput.addEventListener('input', function() {
            let query = this.value;
            if (query.length > 2) {  // Espera hasta que se escriban más de 2 caracteres
                searchLocations(query);
            } else {
                searchResults.style.display = 'none';  // Ocultar los resultados si no hay query
            }
        });

        document.getElementById('searchButton').addEventListener('click', function() {
            var searchInput = document.getElementById('searchInput').value;
            if (searchInput.trim()) {
                // Redirigir a la ruta de Flask para buscar rutas, pasando el destino como parámetro en la URL
                window.location.href = `/buscar_rutas?destination=${encodeURIComponent(searchInput)}`;
            }
        });
    </script>

    {% endblock %}
